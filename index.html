<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>溫濕度感應器儀表板</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
            color: #1f2937;
        }
    </style>
    <!-- 從 CDN 載入 Firebase SDK -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getFirestore, collection, query, onSnapshot, orderBy } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        window.firebase = { initializeApp, getFirestore, collection, query, onSnapshot, orderBy };
    </script>
</head>
<body class="p-4 sm:p-8 md:p-12">

    <div id="chart-container" class="bg-white p-6 rounded-xl shadow-lg border border-gray-200">
        <h1 class="text-2xl sm:text-3xl font-bold text-center mb-4 text-indigo-600">溫濕度感應器即時數據</h1>
        <div class="text-center mb-4">
            <span id="project-info" class="text-xs text-gray-500 mr-2">正在連接到 Firebase...</span>
            <span id="status-dot" class="inline-block w-3 h-3 rounded-full bg-yellow-400"></span>
        </div>
        <div class="relative h-64 sm:h-80 md:h-96">
            <canvas id="tempChart"></canvas>
            <div id="loading" class="absolute inset-0 flex items-center justify-center bg-white bg-opacity-80 rounded-xl transition-opacity duration-300">
                <div class="flex flex-col items-center">
                    <div class="animate-spin rounded-full h-12 w-12 border-4 border-t-4 border-indigo-500"></div>
                    <p class="mt-4 text-gray-500">正在載入數據...</p>
                </div>
            </div>
            <div id="no-data" class="absolute inset-0 flex items-center justify-center bg-white bg-opacity-80 rounded-xl transition-opacity duration-300 hidden">
                <p class="text-gray-500 text-center">目前沒有可用的數據。</p>
            </div>
        </div>
    </div>

    <script type="module">
        let tempChart;
        const ctx = document.getElementById('tempChart').getContext('2d');
        const loadingElement = document.getElementById('loading');
        const noDataElement = document.getElementById('no-data');
        const projectInfoElement = document.getElementById('project-info');
        const statusDot = document.getElementById('status-dot');

        // 你的 Firebase 設定
        const firebaseConfig = {
            apiKey: "AIzaSyAK87kwzBCAbcWn5MUSdt6sUvoaAvLJVBs",
            authDomain: "data-store-b0994.firebaseapp.com",
            projectId: "data-store-b0994",
            storageBucket: "data-store-b0994.firebasestorage.app",
            messagingSenderId: "484608370709",
            appId: "1:484608370709:web:28ed2b8c5a31644ea5861c",
            measurementId: "G-1NBWFP8ZNR"
        };

        /**
         * 初始化 Chart.js 圖表
         */
        function initChart() {
            if (tempChart) {
                tempChart.destroy();
            }
            tempChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [{
                        label: '溫度 (°C)',
                        data: [],
                        borderColor: 'rgb(75, 192, 192)',
                        tension: 0.1,
                        fill: false
                    }, {
                        label: '濕度 (%)',
                        data: [],
                        borderColor: 'rgb(255, 99, 132)',
                        tension: 0.1,
                        fill: false
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        x: {
                            title: {
                                display: true,
                                text: '時間'
                            },
                            ticks: {
                                display: false
                            }
                        },
                        y: {
                            title: {
                                display: true,
                                text: '數值'
                            },
                            beginAtZero: false
                        }
                    },
                    plugins: {
                        legend: {
                            position: 'top',
                        },
                        tooltip: {
                            mode: 'index',
                            intersect: false,
                        }
                    }
                }
            });
        }

        /**
         * 啟動 Firebase 監聽器以讀取即時數據。
         */
        function startFirestoreListener() {
            try {
                // 初始化 Firebase 應用程式
                const app = firebase.initializeApp(firebaseConfig);
                const db = firebase.getFirestore(app);

                // 定義我們要監聽的 Firestore 集合路徑
                const collectionRef = firebase.collection(db, "sensor_data/device1/readings");

                // 使用 onSnapshot 監聽數據變化，並根據 timestamp 排序
                const q = firebase.query(collectionRef, firebase.orderBy("timestamp"));

                firebase.onSnapshot(q, (snapshot) => {
                    loadingElement.classList.add('hidden'); // 隱藏載入中提示
                    statusDot.classList.remove('bg-yellow-400');
                    statusDot.classList.add('bg-green-500');
                    projectInfoElement.textContent = '已連接到 Firebase。';

                    const labels = [];
                    const temperatures = [];
                    const humidities = [];

                    if (snapshot.empty) {
                        noDataElement.classList.remove('hidden'); // 顯示無數據提示
                    } else {
                        noDataElement.classList.add('hidden'); // 隱藏無數據提示
                        snapshot.forEach((doc) => {
                            const data = doc.data();
                            const timestamp = data.timestamp.toDate();
                            labels.push(timestamp.toLocaleTimeString());
                            temperatures.push(data.temperature);
                            humidities.push(data.humidity);
                        });
                    }

                    // 更新圖表數據
                    if (!tempChart) {
                        initChart();
                    }
                    tempChart.data.labels = labels;
                    tempChart.data.datasets[0].data = temperatures;
                    tempChart.data.datasets[1].data = humidities;
                    tempChart.update();
                });

            } catch (error) {
                console.error("Firebase 連接失敗:", error);
                loadingElement.classList.add('hidden');
                statusDot.classList.remove('bg-yellow-400', 'bg-green-500');
                statusDot.classList.add('bg-red-500');
                projectInfoElement.textContent = '連接失敗，請檢查配置和網路。';
            }
        }

        // 當 DOM 完全載入後，啟動應用程式
        window.addEventListener('load', () => {
            initChart(); // 先初始化空圖表
            startFirestoreListener(); // 啟動 Firebase 監聽
        });
    </script>
</body>
</html>
