<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<title>è¾²å ´ç«ç½é è­¦ç›£æ§å„€è¡¨æ¿</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-app.js";
import { getFirestore, collection, query, orderBy, limit, getDocs } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyAK87kwzBCAbcWn5MUSdt6sUvoaAvLJVBs",
  authDomain: "data-store-b0994.firebaseapp.com",
  projectId: "data-store-b0994",
  storageBucket: "data-store-b0994.firebasestorage.app",
  messagingSenderId: "484608370709",
  appId: "1:484608370709:web:9ec8ae5c2c027fe1a5861c",
  measurementId: "G-D6FF040MBX"
};
const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

let mainChart, tempChart, humChart, smokeChart;

async function fetchData(n=40) {
  const q = query(collection(db, "sensor_data"), orderBy("timestamp","desc"), limit(n));
  const snap = await getDocs(q);
  const dataA = [];
  const dataB = [];
  
  snap.forEach(doc => {
    const item = doc.data();
    if(item.id === "B") dataB.push(item);
    else dataA.push(item);
  });
  return { a: dataA.reverse(), b: dataB.reverse() };
}

function formatTime(ts) {
  if(!ts) return "--:--";
  const d = ts.toDate();
  return `${d.getHours()}:${d.getMinutes().toString().padStart(2,'0')}:${d.getSeconds().toString().padStart(2,'0')}`;
}

async function renderCharts() {
  const num = parseInt(document.getElementById("numRecords").value) || 20;
  const { a, b } = await fetchData(num * 2);

  const latestA = a.length > 0 ? a[a.length-1] : {temperature:'--', humidity:'--', smoke:'--', timestamp:null};
  const latestB = b.length > 0 ? b[b.length-1] : {temperature:'--', humidity:'--', timestamp:null};
  
  document.getElementById("latestData").innerHTML = 
    `<span style="color:#e74c3c">è£ç½® A (å®‰å…¨å“¨å…µ): ${latestA.temperature}Â°C / ${latestA.humidity}% / ç…™éœ§: ${latestA.smoke || 0}</span> | ` +
    `<span style="color:#3498db">è£ç½® B: ${latestB.temperature}Â°C / ${latestB.humidity}%</span>`;

  if(mainChart) mainChart.destroy();
  if(tempChart) tempChart.destroy();
  if(humChart) humChart.destroy();
  if(smokeChart) smokeChart.destroy();

  const labelsA = a.map(d => d.timestamp);

  // 1. ä¸»å°æ¯”åœ–è¡¨ (åŒ…å«ç…™éœ§é›™è»¸)
  mainChart = new Chart(document.getElementById("mainChart"), {
    type:'line',
    data:{
      labels: labelsA,
      datasets:[
        { label:'Aå€ æº«åº¦', data: a.map(d=>d.temperature), borderColor:'red', yAxisID:'y', tension:0.3 },
        { label:'Bå€ æº«åº¦', data: b.map(d=>d.temperature), borderColor:'orange', yAxisID:'y', tension:0.3 },
        { label:'Aå€ ç…™éœ§æ¿ƒåº¦', data: a.map(d=>d.smoke || 0), borderColor:'green', backgroundColor:'rgba(0,255,0,0.1)', fill:true, yAxisID:'y1', tension:0.3 }
      ]
    },
    options:{
      responsive:true, maintainAspectRatio:false,
      scales:{
        y: { type:'linear', display:true, position:'left', title:{display:true, text:'æº«åº¦ (Â°C)'} },
        y1: { type:'linear', display:true, position:'right', grid:{drawOnChartArea:false}, title:{display:true, text:'ç…™éœ§å€¼ (0-1024)'} },
        x: { ticks:{ callback:(v,i)=>formatTime(labelsA[i]) } }
      }
    }
  });

  // 2. ç¨ç«‹æº«åº¦åœ–
  tempChart = new Chart(document.getElementById("tempChart"), {
    type:'line',
    data:{ labels: labelsA, datasets:[{label:'æº«åº¦', data: a.map(d=>d.temperature), borderColor:'red'}] },
    options:{ responsive:true, maintainAspectRatio:false }
  });

  // 3. ç¨ç«‹æ¿•åº¦åœ–
  humChart = new Chart(document.getElementById("humChart"), {
    type:'line',
    data:{ labels: labelsA, datasets:[{label:'æ¿•åº¦', data: a.map(d=>d.humidity), borderColor:'blue'}] },
    options:{ responsive:true, maintainAspectRatio:false }
  });

  // 4. ç¨ç«‹ç…™éœ§åœ– (æ–°å¢)
  smokeChart = new Chart(document.getElementById("smokeChart"), {
    type:'line',
    data:{ labels: labelsA, datasets:[{label:'ç…™éœ§æ¿ƒåº¦ (Aå€)', data: a.map(d=>d.smoke || 0), borderColor:'green', backgroundColor:'rgba(0,255,0,0.2)', fill:true}] },
    options:{ 
        responsive:true, maintainAspectRatio:false,
        scales: { y: { min: 0, max: 1024 } }
    }
  });
}

window.onload = () => renderCharts();
window.refreshCharts = renderCharts;
</script>

<style>
body{font-family:sans-serif;text-align:center;margin:0;padding:20px;background:#f0f2f5;}
#latestData{margin:15px;font-size:16px;font-weight:bold;background:white;padding:10px;border-radius:5px;box-shadow:0 2px 4px rgba(0,0,0,0.1);}
.chart-container{
  display:grid;
  grid-template-columns:1fr 1fr 1fr;
  grid-template-rows:auto auto;
  gap:15px;
  width:95%;
  margin:0 auto;
}
.chart-wrapper{background:white; padding:15px; border-radius:8px; box-shadow:0 2px 5px rgba(0,0,0,0.05);}
#mainChartWrapper{grid-column: span 3; height:450px;}
.small-chart{height:250px;}
</style>
</head>
<body>
<h2>ğŸ›¡ï¸ è¾²å ´å¤šé»å®‰å…¨ç›£æ§ç³»çµ±</h2>
<div id="latestData">è®€å– Firebase æ•¸æ“šä¸­...</div>
<div style="margin-bottom:15px;">
  é¡¯ç¤ºç­†æ•¸: <input id="numRecords" type="number" value="20" style="width:50px">
  <button onclick="refreshCharts()">æ‰‹å‹•æ›´æ–°</button>
</div>
<div class="chart-container">
  <div class="chart-wrapper" id="mainChartWrapper"><canvas id="mainChart"></canvas></div>
  <div class="chart-wrapper small-chart"><canvas id="tempChart"></canvas></div>
  <div class="chart-wrapper small-chart"><canvas id="humChart"></canvas></div>
  <div class="chart-wrapper small-chart"><canvas id="smokeChart"></canvas></div>
</div>
</body>
</html>