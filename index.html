<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>IoT 數據儀表板</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/mqtt/dist/mqtt.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }
    </style>
</head>
<body class="bg-gray-100 min-h-screen p-4 sm:p-8 flex items-center justify-center">

<div class="w-full max-w-5xl bg-white rounded-lg shadow-xl p-6 sm:p-8">
    <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-6">
        <h1 class="text-2xl sm:text-3xl font-bold text-gray-800 mb-2 sm:mb-0">IoT 數據儀表板</h1>
        <div class="flex flex-col sm:flex-row items-end sm:items-center space-x-0 sm:space-x-4">
            <div id="status-container" class="flex items-center space-x-2 mb-2 sm:mb-0">
                <span id="mqtt-status-dot" class="block w-3 h-3 rounded-full animate-pulse bg-red-500"></span>
                <span id="mqtt-status-text" class="px-4 py-2 rounded-full text-sm font-semibold bg-red-100 text-red-800">
                    正在連線...
                </span>
            </div>
            <div id="user-id-container" class="text-xs text-gray-500">
                <span id="user-id-display">使用者 ID: ---</span>
            </div>
        </div>
    </div>

    <div id="error-message" class="hidden bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded relative mb-4" role="alert">
        <strong class="font-bold">連線失敗：</strong>
        <span class="block sm:inline" id="error-text"></span>
    </div>

    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 sm:gap-6 mb-8">
        <div class="bg-blue-50 p-6 rounded-lg shadow-md flex-1">
            <h2 class="text-xl font-semibold text-blue-800 mb-2">溫度</h2>
            <p id="temperature-display" class="text-4xl sm:text-5xl font-extrabold text-blue-600">---</p>
            <span class="text-gray-500 mt-1">°C</span>
        </div>
        <div class="bg-green-50 p-6 rounded-lg shadow-md flex-1">
            <h2 class="text-xl font-semibold text-green-800 mb-2">濕度</h2>
            <p id="humidity-display" class="text-4xl sm:text-5xl font-extrabold text-green-600">---</p>
            <span class="text-gray-500 mt-1">%</span>
        </div>
    </div>

    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 sm:gap-6">
        <div class="bg-white p-6 rounded-lg shadow-md">
            <canvas id="temperatureChart"></canvas>
        </div>
        <div class="bg-white p-6 rounded-lg shadow-md">
            <canvas id="humidityChart"></canvas>
        </div>
    </div>

</div>

<script type="module">
    // Firebase SDK imports
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
    import { getFirestore, doc, getDoc, addDoc, setDoc, updateDoc, deleteDoc, onSnapshot, collection, query, limit, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

    // -------------------------------------------------------------------------
    // 全域變數和 Firebase 配置
    // -------------------------------------------------------------------------
    const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
    const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
    const firebaseConfigString = typeof __firebase_config !== 'undefined' ? __firebase_config : null;

    let app, auth, db, userId;
    let client = null;
    let temperatureChart = null;
    let humidityChart = null;
    let isInitialized = false;

    // 備用 Firebase 專案配置資訊 (在 Canvas 環境中通常不會用到)
    const YOUR_FIREBASE_CONFIG = {
        apiKey: "AIzaSyACJre2XVZ3KI3jAfsewGjFmhSV219ztO0",
        authDomain: "th-re-m.firebaseapp.com",
        projectId: "th-re-m",
        storageBucket: "th-re-m.firebasestorage.app",
        messagingSenderId: "831215013774",
        appId: "1:831215013774:web:1a11969fd77e8db6c21edf",
        measurementId: "G-NFD3S3V69L"
    };

    // HiveMQ Cloud 連線資訊
    const HIVE_MQ_HOST = '2031fa74565b431694eda7e9d0d88f90.s1.eu.hivemq.cloud';
    const HIVE_MQ_PORT = 8884;
    const HIVE_MQ_TOPIC = 'TH_data';
    const HIVE_MQ_USERNAME = 'TH_farmer';
    const HIVE_MQ_PASSWORD = 'Th123456789';

    const MQTT_STATUS = {
        CONNECTING: '正在連線...',
        CONNECTED: '已連線',
        DISCONNECTED: '已斷線',
        ERROR: '連線錯誤',
    };

    /**
     * 更新儀表板上的狀態顯示。
     * @param {string} status 要顯示的狀態。
     */
    const updateStatus = (status) => {
        const statusText = document.getElementById('mqtt-status-text');
        const statusDot = document.getElementById('mqtt-status-dot');
        statusText.textContent = status;
        statusDot.className = 'block w-3 h-3 rounded-full animate-pulse';
        const colorMap = {
            [MQTT_STATUS.CONNECTED]: 'green',
            [MQTT_STATUS.CONNECTING]: 'yellow',
            [MQTT_STATUS.DISCONNECTED]: 'red',
            [MQTT_STATUS.ERROR]: 'red',
        };
        const color = colorMap[status] || 'red';
        statusText.className = `px-4 py-2 rounded-full text-sm font-semibold bg-${color}-100 text-${color}-800`;
        statusDot.classList.add(`bg-${color}-500`);
    };

    /**
     * 在儀表板上顯示錯誤訊息。
     * @param {string} message 要顯示的錯誤訊息。
     */
    const displayError = (message) => {
        const errorContainer = document.getElementById('error-message');
        const errorText = document.getElementById('error-text');
        errorText.textContent = message;
        errorContainer.classList.remove('hidden');
    };

    /**
     * 初始化 Chart.js 圖表。
     */
    const initCharts = () => {
        const tempCtx = document.getElementById('temperatureChart').getContext('2d');
        const humCtx = document.getElementById('humidityChart').getContext('2d');

        if (temperatureChart) { temperatureChart.destroy(); }
        if (humidityChart) { humidityChart.destroy(); }
        
        temperatureChart = new Chart(tempCtx, {
            type: 'line',
            data: { labels: [], datasets: [{ label: '溫度 (°C)', data: [], borderColor: 'rgb(255, 99, 132)', backgroundColor: 'rgba(255, 99, 132, 0.5)', tension: 0.1 }] },
            options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false }, title: { display: true, text: '即時溫度趨勢' } }, scales: { x: { title: { display: true, text: '時間' } }, y: { title: { display: true, text: '溫度 (°C)' } } } }
        });
        humidityChart = new Chart(humCtx, {
            type: 'line',
            data: { labels: [], datasets: [{ label: '濕度 (%)', data: [], borderColor: 'rgb(53, 162, 235)', backgroundColor: 'rgba(53, 162, 235, 0.5)', tension: 0.1 }] },
            options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false }, title: { display: true, text: '即時濕度趨勢' } }, scales: { x: { title: { display: true, text: '時間' } }, y: { title: { display: true, text: '濕度 (%)' } } } }
        });
    };

    /**
     * 處理 MQTT 接收到的數據並更新儀表板和 Firestore。
     * @param {string} messageString 接收到的 MQTT 訊息。
     */
    const handleMqttMessage = async (messageString) => {
        let temp, hum;
        try {
            const data = JSON.parse(messageString);
            if (data.hasOwnProperty('temperature') && data.hasOwnProperty('humidity')) {
                temp = data.temperature;
                hum = data.humidity;
            } else if (data.hasOwnProperty('temp') && data.hasOwnProperty('hum')) {
                temp = data.temp;
                hum = data.hum;
            } else {
                throw new Error('數據格式不正確，缺少 temperature/temp 或 humidity/hum 屬性。');
            }
        } catch (e) {
            const parts = messageString.split(',').map(part => parseFloat(part.trim()));
            if (parts.length >= 2 && !isNaN(parts[0]) && !isNaN(parts[1])) {
                temp = parts[0];
                hum = parts[1];
            } else {
                console.error('❌ 無法解析數據:', messageString);
                displayError(`無法解析數據: ${messageString}`);
                return;
            }
        }

        if (typeof temp === 'number' && typeof hum === 'number' && !isNaN(temp) && !isNaN(hum)) {
            document.getElementById('temperature-display').textContent = temp.toFixed(1);
            document.getElementById('humidity-display').textContent = hum.toFixed(1);
            
            try {
                await addDoc(collection(db, `artifacts/${appId}/public/data/th_readings`), {
                    temperature: temp,
                    humidity: hum,
                    timestamp: serverTimestamp()
                });
                console.log("✅ 數據已成功寫入 Firestore。");
            } catch (firestoreError) {
                console.error("❌ 寫入 Firestore 失敗:", firestoreError);
            }
        } else {
            console.error('❌ 無效的溫濕度數據:', { temp, hum });
            displayError('無效的溫濕度數據，請檢查發送格式。');
        }
    };

    /**
     * 連接到 MQTT 伺服器並設置監聽器。
     */
    const connectToMqtt = () => {
        updateStatus(MQTT_STATUS.CONNECTING);
        try {
            const connectUrl = `wss://${HIVE_MQ_HOST}:${HIVE_MQ_PORT}/mqtt`;
            client = mqtt.connect(connectUrl, {
                clientId: 'mqttjs_' + Math.random().toString(16).substr(2, 8),
                username: HIVE_MQ_USERNAME,
                password: HIVE_MQ_PASSWORD,
            });

            client.on('connect', () => {
                console.log('✅ 已成功連接 MQTT 伺服器');
                updateStatus(MQTT_STATUS.CONNECTED);
                client.subscribe(HIVE_MQ_TOPIC, (err) => {
                    if (err) {
                        console.error('❌ 訂閱失敗:', err);
                        displayError(`訂閱主題失敗: ${err.message}`);
                        updateStatus(MQTT_STATUS.ERROR);
                    } else {
                        console.log(`✅ 成功訂閱主題: ${HIVE_MQ_TOPIC}`);
                    }
                });
            });

            client.on('message', (topic, message) => handleMqttMessage(message.toString()));
            client.on('error', (err) => {
                console.error('❌ MQTT 連線錯誤:', err);
                displayError(`連線錯誤: ${err.message}`);
                updateStatus(MQTT_STATUS.ERROR);
                client.end();
            });
            client.on('close', () => {
                console.log('連線已關閉');
                updateStatus(MQTT_STATUS.DISCONNECTED);
            });
        } catch (e) {
            console.error("❌ 連線失敗:", e);
            displayError(`連線失敗: ${e.message}`);
            updateStatus(MQTT_STATUS.ERROR);
        }
    };

    /**
     * 監聽 Firestore 的即時數據。
     */
    const listenToFirestore = () => {
        const thReadingsRef = collection(db, `artifacts/${appId}/public/data/th_readings`);
        const q = query(thReadingsRef, limit(50));

        onSnapshot(q, (querySnapshot) => {
            const readings = [];
            querySnapshot.forEach((doc) => {
                const data = doc.data();
                if (data.timestamp && data.timestamp.toDate) {
                    readings.push(data);
                }
            });
            readings.sort((a, b) => a.timestamp.toDate() - b.timestamp.toDate());
            
            if (readings.length > 0) {
                const labels = readings.map(d => d.timestamp.toDate().toLocaleTimeString());
                const temperatures = readings.map(d => d.temperature);
                const humidities = readings.map(d => d.humidity);

                temperatureChart.data.labels = labels;
                temperatureChart.data.datasets[0].data = temperatures;
                temperatureChart.update();

                humidityChart.data.labels = labels;
                humidityChart.data.datasets[0].data = humidities;
                humidityChart.update();
            }
            console.log("✅ 從 Firestore 收到即時更新 (已排序):", readings);
        }, (error) => {
            console.error("❌ Firestore 監聽失敗:", error);
            displayError(`Firestore 監聽失敗: ${error.message}`);
        });
    };

    /**
     * 主應用程式初始化函式。
     */
    const initApp = async () => {
        if (isInitialized) return;
        isInitialized = true;
        
        let firebaseConfig;
        if (firebaseConfigString) {
            try {
                firebaseConfig = JSON.parse(firebaseConfigString);
                console.log("✅ 使用 Canvas 環境提供的 Firebase 配置。");
            } catch (e) {
                console.warn("⚠️ 無法解析 Canvas Firebase 配置，使用備用配置。");
                firebaseConfig = YOUR_FIREBASE_CONFIG;
            }
        } else {
            firebaseConfig = YOUR_FIREBASE_CONFIG;
            console.warn("⚠️ 缺少 Canvas Firebase 配置，使用備用配置。");
        }
        
        try {
            app = initializeApp(firebaseConfig);
            auth = getAuth(app);
            db = getFirestore(app);

            if (initialAuthToken) {
                try {
                    await signInWithCustomToken(auth, initialAuthToken);
                    console.log("✅ 成功使用自訂令牌登入。");
                } catch (error) {
                    console.warn("⚠️ 自訂令牌登入失敗，正在嘗試匿名登入...", error);
                    await signInAnonymously(auth);
                }
            } else {
                await signInAnonymously(auth);
                console.log("✅ 成功使用匿名登入。");
            }
            
            userId = auth.currentUser?.uid || crypto.randomUUID();
            document.getElementById('user-id-display').textContent = `使用者 ID: ${userId}`;
            console.log("✅ Firebase 已成功初始化。");
            
            listenToFirestore();
            connectToMqtt();
        } catch (e) {
            console.error("❌ 應用程式初始化失敗:", e);
            displayError(`應用程式初始化失敗: ${e.message}`);
        }
    };

    document.addEventListener('DOMContentLoaded', () => {
        initCharts();
        initApp();
    });
</script>
</body>
</html>
