<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<title>溫濕度監控儀表板</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-app.js";
import { getFirestore, collection, query, orderBy, limit, getDocs } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyAK87kwzBCAbcWn5MUSdt6sUvoaAvLJVBs",
  authDomain: "data-store-b0994.firebaseapp.com",
  projectId: "data-store-b0994",
  storageBucket: "data-store-b0994.firebasestorage.app",
  messagingSenderId: "484608370709",
  appId: "1:484608370709:web:9ec8ae5c2c027fe1a5861c",
  measurementId: "G-D6FF040MBX"
};
const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

let mainChart, tempChart, humChart;

async function fetchData(n=20) {
  const q = query(collection(db, "sensor_data"), orderBy("timestamp","desc"), limit(n));
  const snap = await getDocs(q);
  const data = [];
  snap.forEach(doc=>data.push(doc.data()));
  return data.reverse();
}

function detectOutliers(values) {
  const avg = values.reduce((a,b)=>a+b,0)/values.length;
  return values.map(v=>Math.abs(v-avg)>5);
}

function formatTime(ts) {
  const d = ts.toDate();
  return `${d.getHours()}:${d.getMinutes().toString().padStart(2,'0')}:${d.getSeconds().toString().padStart(2,'0')}`;
}

async function renderCharts() {
  const num = parseInt(document.getElementById("numRecords").value) || 20;
  const data = await fetchData(num);
  if(data.length===0) return;

  const labels = data.map(d=>d.timestamp);
  const temps = data.map(d=>d.temperature);
  const hums = data.map(d=>d.humidity);
  const outliers = detectOutliers(temps);

  const latest = data[data.length-1];
  document.getElementById("latestData").innerText =
    `最新時間: ${formatTime(latest.timestamp)} | 溫度: ${latest.temperature}°C | 濕度: ${latest.humidity}%`;

  if(mainChart) mainChart.destroy();
  if(tempChart) tempChart.destroy();
  if(humChart) humChart.destroy();

  mainChart = new Chart(document.getElementById("mainChart"), {
    type:'line',
    data:{
      labels,
      datasets:[
        {
          label:'溫度 (°C)',
          data:temps,
          borderColor:'red',
          pointBackgroundColor: outliers.map(o=>o?'red':'red'),
          pointRadius: outliers.map(o=>o?6:4),
          fill:false,
          tension:0.1
        },
        {
          label:'濕度 (%)',
          data:hums,
          borderColor:'blue',
          pointBackgroundColor:'blue',
          pointRadius:4,
          fill:false,
          tension:0.1
        }
      ]
    },
    options:{
      responsive:true,
      maintainAspectRatio:false,
      plugins:{
        legend:{position:'top', align:'end', labels:{font:{size:12}}},
        tooltip:{callbacks:{title: items => formatTime(labels[items[0].dataIndex])}}
      },
      scales:{
        x:{ticks:{maxRotation:0, autoSkip:true, maxTicksLimit:6, callback:(v,i)=>formatTime(labels[i])}}
      }
    }
  });

  tempChart = new Chart(document.getElementById("tempChart"), {
    type:'line',
    data:{
      labels,
      datasets:[{
        label:'溫度 (°C)',
        data:temps,
        borderColor:'red',
        pointBackgroundColor: outliers.map(o=>o?'red':'red'),
        pointRadius: outliers.map(o=>o?6:4),
        fill:false,
        tension:0.1
      }]
    },
    options:{
      responsive:true,
      maintainAspectRatio:false,
      plugins:{tooltip:{callbacks:{title: items=>formatTime(labels[items[0].dataIndex])}}},
      scales:{x:{ticks:{autoSkip:true,maxTicksLimit:6,callback:(v,i)=>formatTime(labels[i])}}}
    }
  });

  humChart = new Chart(document.getElementById("humChart"), {
    type:'line',
    data:{
      labels,
      datasets:[{
        label:'濕度 (%)',
        data:hums,
        borderColor:'blue',
        pointBackgroundColor:'blue',
        pointRadius:4,
        fill:false,
        tension:0.1
      }]
    },
    options:{
      responsive:true,
      maintainAspectRatio:false,
      plugins:{tooltip:{callbacks:{title: items=>formatTime(labels[items[0].dataIndex])}}},
      scales:{x:{ticks:{autoSkip:true,maxTicksLimit:6,callback:(v,i)=>formatTime(labels[i])}}}
    }
  });
}

window.onload = ()=>renderCharts();
window.refreshCharts = renderCharts;
</script>

<style>
body{font-family:sans-serif;text-align:center;margin:0;padding:20px;background:#f3f4f6;}
#latestData{margin:15px;font-size:18px;font-weight:bold;}
.controls{margin-bottom:15px;}
.chart-container{
  display:grid;
  grid-template-columns:1fr 1fr;
  grid-template-rows:auto auto;
  gap:20px;
  width:90%;
  margin:0 auto;
}
.chart-wrapper{width:100%;}
#mainChart{grid-column: span 2;height:400px !important;}
#tempChart,#humChart{height:200px !important;}
</style>
</head>
<body>
<h2>溫濕度監控儀表板</h2>
<div id="latestData">讀取中...</div>
<div class="controls">
筆數: <input id="numRecords" type="number" value="20" min="5" max="100">
<button onclick="refreshCharts()">更新</button>
</div>
<div class="chart-container">
  <div class="chart-wrapper"><canvas id="mainChart"></canvas></div>
  <div class="chart-wrapper"><canvas id="tempChart"></canvas></div>
  <div class="chart-wrapper"><canvas id="humChart"></canvas></div>
</div>
</body>
</html>
