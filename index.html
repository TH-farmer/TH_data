<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>溫濕度感應器儀表板</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
            color: #1f2937;
        }
    </style>
</head>
<body class="p-4 sm:p-8 md:p-12">

    <div id="chart-container" class="bg-white p-6 rounded-xl shadow-lg border border-gray-200">
        <h1 class="text-2xl sm:text-3xl font-bold text-center mb-4 text-indigo-600">溫濕度感應器即時數據 (離線模式)</h1>
        <p id="project-info" class="text-xs text-red-500 text-center mb-2">無法連接到 Firebase。正在使用模擬數據。</p>
        <p id="data-path-display" class="text-sm text-gray-500 text-center mb-4"></p>
        <div class="relative h-64 sm:h-80 md:h-96">
            <canvas id="tempChart"></canvas>
            <div id="loading" class="absolute inset-0 flex items-center justify-center bg-white bg-opacity-80 rounded-xl transition-opacity duration-300 hidden">
                <div class="flex flex-col items-center">
                    <div class="animate-spin rounded-full h-12 w-12 border-4 border-t-4 border-indigo-500"></div>
                    <p class="mt-4 text-gray-500">正在從 Firestore 載入數據...</p>
                </div>
            </div>
            <div id="no-data" class="absolute inset-0 flex items-center justify-center bg-white bg-opacity-80 rounded-xl transition-opacity duration-300 hidden">
                <p class="text-gray-500 text-center">目前資料庫中沒有可用的溫濕度數據。</p>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInWithCustomToken, signInAnonymously } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, query, onSnapshot, orderBy, limit } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // 從環境變數中取得 Firebase 配置
        const firebaseConfigString = typeof __firebase_config !== 'undefined' ? __firebase_config : null;
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
        
        // UI 元素
        const projectInfoElement = document.getElementById('project-info');
        const dataPathDisplay = document.getElementById('data-path-display');
        const loadingElement = document.getElementById('loading');
        const noDataElement = document.getElementById('no-data');
        const ctx = document.getElementById('tempChart').getContext('2d');

        let app, db, auth;
        let tempChart;

        // 嘗試初始化 Firebase
        try {
            if (!firebaseConfigString || firebaseConfigString.trim() === '') {
                // 如果沒有提供配置，則使用一個模擬的配置
                console.warn("Firebase 配置(__firebase_config)為空。正在使用模擬配置。");
                const firebaseConfig = {
                    apiKey: "fake-api-key",
                    authDomain: "fake-project.firebaseapp.com",
                    projectId: "fake-project-id"
                };
                app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                projectInfoElement.textContent = `無法連接到 Firebase。正在使用模擬數據。`;
                dataPathDisplay.textContent = `正在讀取集合: sensor_data`;
            } else {
                const firebaseConfig = JSON.parse(firebaseConfigString);
                if (!firebaseConfig.projectId) {
                    throw new Error('Firebase 配置中未提供 "projectId"。');
                }
                // 初始化 Firebase
                app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                projectInfoElement.textContent = `專案 ID: ${firebaseConfig.projectId}`;
                dataPathDisplay.textContent = `正在讀取集合: sensor_data`;
            }
        } catch (error) {
            console.error("Firebase 初始化失敗:", error);
            if (loadingElement) loadingElement.classList.add('hidden');
            if (noDataElement) {
                noDataElement.textContent = `Firebase 初始化失敗: ${error.message}`;
                noDataElement.classList.remove('hidden');
            }
            // 阻止腳本繼續執行
            throw error;
        }

        // 初始化圖表
        function initChart() {
            if (tempChart) {
                tempChart.destroy();
            }
            tempChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [{
                        label: '溫度 (°C)',
                        data: [],
                        borderColor: 'rgb(75, 192, 192)',
                        tension: 0.1,
                        fill: false
                    }, {
                        label: '濕度 (%)',
                        data: [],
                        borderColor: 'rgb(255, 99, 132)',
                        tension: 0.1,
                        fill: false
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        x: {
                            title: {
                                display: true,
                                text: '時間'
                            },
                            ticks: {
                                display: false // 隱藏 X 軸標籤以避免擁擠
                            }
                        },
                        y: {
                            title: {
                                display: true,
                                text: '數值'
                            },
                            beginAtZero: false
                        }
                    },
                    plugins: {
                        legend: {
                            position: 'top',
                        },
                        tooltip: {
                            mode: 'index',
                            intersect: false,
                        }
                    }
                }
            });
        }

        // 從 Firestore 讀取資料
        async function fetchSensorData() {
            try {
                // 使用自訂憑證或匿名登入
                if (initialAuthToken) {
                    await signInWithCustomToken(auth, initialAuthToken);
                } else {
                    await signInAnonymously(auth);
                }
                
                const collectionPath = "sensor_data";
                const collectionRef = collection(db, collectionPath);
                
                // 建立查詢，依照時間戳記排序並限制為最近 100 筆
                const q = query(collectionRef, orderBy("timestamp", "asc"), limit(100));

                onSnapshot(q, (snapshot) => {
                    const chartData = {
                        labels: [],
                        temperatures: [],
                        humidities: []
                    };
                    
                    if (snapshot.empty) {
                        console.log("快照為空，資料庫中沒有數據。");
                        loadingElement.classList.add('hidden');
                        noDataElement.classList.remove('hidden');
                        if (tempChart) tempChart.destroy();
                        return;
                    }
                    
                    snapshot.forEach((doc) => {
                        const data = doc.data();
                        console.log("讀取到文件:", data); // 在主控台印出每一筆文件
                        // 確保 timestamp 存在且是數字
                        const timestamp = data.timestamp ? new Date(data.timestamp * 1000).toLocaleTimeString() : 'N/A';
                        if (data.temperature !== undefined) {
                            chartData.labels.push(timestamp);
                            chartData.temperatures.push(data.temperature);
                            chartData.humidities.push(data.humidity);
                        }
                    });

                    if (chartData.labels.length > 0) {
                        loadingElement.classList.add('hidden');
                        noDataElement.classList.add('hidden');
                        if (!tempChart) {
                            initChart();
                        }
                        tempChart.data.labels = chartData.labels;
                        tempChart.data.datasets[0].data = chartData.temperatures;
                        tempChart.data.datasets[1].data = chartData.humidities;
                        tempChart.update();
                    }
                }, (error) => {
                    console.error("即時讀取 Firestore 數據時發生錯誤:", error);
                    loadingElement.classList.add('hidden');
                    noDataElement.textContent = "載入資料時發生錯誤。請檢查瀏覽器控制台。";
                    noDataElement.classList.remove('hidden');
                });

            } catch (error) {
                console.error("Firebase 認證或讀取失敗:", error);
                loadingElement.classList.add('hidden');
                noDataElement.textContent = `Firebase 認證失敗: ${error.message}`;
                noDataElement.classList.remove('hidden');
            }
        }

        document.addEventListener('DOMContentLoaded', () => {
            initChart();
            fetchSensorData();
        });
    </script>
</body>
</html>
