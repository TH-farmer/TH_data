<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>即時感測器數據儀表板</title>
    <!-- 載入 Tailwind CSS for styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- 載入 Chart.js for data visualization -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
        }
        .container {
            max-width: 1200px;
        }
    </style>
</head>
<body class="bg-gray-100 p-6 flex items-center justify-center min-h-screen">

    <div class="container bg-white shadow-xl rounded-2xl p-8 space-y-8 max-w-4xl w-full">
        <!-- 標題 -->
        <div class="text-center space-y-2">
            <h1 class="text-3xl font-bold text-gray-800">感測器數據儀表板</h1>
            <p class="text-gray-500">即時監控溫度與濕度數據</p>
        </div>

        <!-- 圖表區 -->
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
            <!-- 溫度圖表 -->
            <div class="bg-blue-50 border border-blue-200 rounded-xl p-4 shadow-sm">
                <h2 class="text-xl font-semibold text-blue-800 mb-4">溫度變化 (C°)</h2>
                <div class="relative h-64">
                    <canvas id="temperatureChart"></canvas>
                </div>
            </div>
            <!-- 濕度圖表 -->
            <div class="bg-green-50 border border-green-200 rounded-xl p-4 shadow-sm">
                <h2 class="text-xl font-semibold text-green-800 mb-4">濕度變化 (%)</h2>
                <div class="relative h-64">
                    <canvas id="humidityChart"></canvas>
                </div>
            </div>
        </div>

        <!-- 數據表格區 -->
        <div class="bg-gray-50 border border-gray-200 rounded-xl p-6 shadow-sm">
            <h2 class="text-2xl font-semibold text-gray-800 mb-4">最新數據</h2>
            <div class="overflow-x-auto rounded-lg border border-gray-300">
                <table id="dataTable" class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-100">
                        <tr>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">時間戳記</th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">溫度 (C°)</th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">濕度 (%)</th>
                        </tr>
                    </thead>
                    <tbody class="bg-white divide-y divide-gray-200">
                        <!-- 資料將會透過 JavaScript 動態生成 -->
                    </tbody>
                </table>
            </div>
            <p id="data-status" class="mt-4 text-center text-sm text-gray-600">正在載入數據...</p>
        </div>
    </div>

    <!-- Firebase 和應用程式邏輯 -->
    <script type="module">
        // Firebase 相關 import
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInWithCustomToken, signInAnonymously } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, query, onSnapshot, orderBy } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // 全域變數，由 Canvas 環境自動提供
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : null;
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        let db;
        let auth;
        let tempChart, humChart;

        // 初始化 Firebase
        async function initializeFirebase() {
            try {
                if (!firebaseConfig) {
                    console.error("Firebase config is missing.");
                    document.getElementById('data-status').textContent = "錯誤：缺少 Firebase 配置。";
                    return;
                }

                const app = initializeApp(firebaseConfig);
                auth = getAuth(app);
                db = getFirestore(app);

                // 根據是否有認證代幣進行登入
                if (initialAuthToken) {
                    await signInWithCustomToken(auth, initialAuthToken);
                } else {
                    await signInAnonymously(auth);
                }
                console.log("Firebase 認證成功！");

                // 認證成功後，開始監聽資料
                setupDataListener();

            } catch (error) {
                console.error("Firebase 連線失敗:", error);
                document.getElementById('data-status').textContent = `Firebase 連線失敗: ${error.message}`;
            }
        }

        // 設定資料監聽器
        function setupDataListener() {
            const userId = auth.currentUser?.uid || 'anonymous';
            const dataPath = `artifacts/${appId}/public/data/sensor_data`;

            const dataCollection = collection(db, dataPath);
            // 注意：我們移除 orderBy 以避免潛在的索引問題，改為在客戶端排序。
            const q = query(dataCollection);

            onSnapshot(q, (snapshot) => {
                const data = [];
                snapshot.forEach((doc) => {
                    data.push({ id: doc.id, ...doc.data() });
                });

                // 根據時間戳記在客戶端進行排序
                data.sort((a, b) => (b.timestamp || 0) - (a.timestamp || 0));

                updateUI(data);
                console.log("數據已更新。", data);
            }, (error) => {
                console.error("即時資料監聽失敗:", error);
                document.getElementById('data-status').textContent = `資料監聽失敗: ${error.message}`;
            });
        }

        // 更新 UI (圖表和表格)
        function updateUI(data) {
            const tableBody = document.querySelector('#dataTable tbody');
            tableBody.innerHTML = ''; // 清空舊的表格內容

            const timestamps = [];
            const temperatures = [];
            const humidities = [];

            if (data.length === 0) {
                document.getElementById('data-status').textContent = "尚無數據。請在 Firestore 中新增文件。";
                return;
            }

            // 處理數據並更新圖表
            data.slice(0, 20).reverse().forEach(item => { // 只顯示最新的20筆數據
                const timestamp = item.timestamp ? new Date(item.timestamp).toLocaleTimeString() : 'N/A';
                timestamps.push(timestamp);
                temperatures.push(item.temperature);
                humidities.push(item.humidity);

                // 建立表格行
                const row = document.createElement('tr');
                row.className = 'bg-white hover:bg-gray-50';
                row.innerHTML = `
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${timestamp}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${item.temperature !== undefined ? item.temperature.toFixed(2) : 'N/A'} °C</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${item.humidity !== undefined ? item.humidity.toFixed(2) : 'N/A'} %</td>
                `;
                tableBody.prepend(row); // 將新行加到最前面
            });

            // 初始化或更新圖表
            if (!tempChart) {
                const tempCtx = document.getElementById('temperatureChart').getContext('2d');
                tempChart = new Chart(tempCtx, {
                    type: 'line',
                    data: {
                        labels: timestamps,
                        datasets: [{
                            label: '溫度 (C°)',
                            data: temperatures,
                            borderColor: 'rgb(59, 130, 246)',
                            backgroundColor: 'rgba(59, 130, 246, 0.2)',
                            tension: 0.1,
                            fill: true
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            x: { title: { display: true, text: '時間' } },
                            y: { title: { display: true, text: '溫度 (C°)' } }
                        }
                    }
                });
            } else {
                tempChart.data.labels = timestamps;
                tempChart.data.datasets[0].data = temperatures;
                tempChart.update();
            }

            if (!humChart) {
                const humCtx = document.getElementById('humidityChart').getContext('2d');
                humChart = new Chart(humCtx, {
                    type: 'line',
                    data: {
                        labels: timestamps,
                        datasets: [{
                            label: '濕度 (%)',
                            data: humidities,
                            borderColor: 'rgb(34, 197, 94)',
                            backgroundColor: 'rgba(34, 197, 94, 0.2)',
                            tension: 0.1,
                            fill: true
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            x: { title: { display: true, text: '時間' } },
                            y: { title: { display: true, text: '濕度 (%)' } }
                        }
                    }
                });
            } else {
                humChart.data.labels = timestamps;
                humChart.data.datasets[0].data = humidities;
                humChart.update();
            }
            
            document.getElementById('data-status').textContent = "數據已成功載入並即時更新！";
        }

        // 在窗口載入完成後啟動 Firebase
        window.onload = initializeFirebase;
    </script>
</body>
</html>
